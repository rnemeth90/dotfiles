#!/usr/bin/env bash
# view man pages as html

if [[ "$1" == "-h" || "$1" == "--help" ]]; then cat <<HELP
Manpage-as-HTML Viewer

Usage: $(basename "$0") [section] name

View a manpage as HTML in the default viewer. Because sometimes
you don't want to view manpages in the terminal.

HELP
exit; fi

if [ ! "$1" ]; then
  echo 'What manual page do you want?!'
  exit
fi

cache_dir=~/cache/manh

# Figure out what the filename should be.
file="$cache_dir/${2:+$2.}$1.html"

# Create directory if it doesn't exist.
[[ -e "$cache_dir" ]] || sudo mkdir -p "$cache_dir"

sudo chmod 755 "$cache_dir"
sudo chown -R "$USER":"$USER" "$cache_dir"

# Create HTML if it doesn't exist.
[[ ! -e "$file" ]] && man "$@" >/dev/null && cat > "$file" <<EOF
<!doctype html>
<html>
<link rel="stylesheet" href="../.conf/manh/styles.css">
<body>
$(MANWIDTH=120 man "$@" 2>/dev/null | man2html -bare -nodepage)
</body>
</html>
EOF

# Open HTML (if it does exist).
for cmd in xdg-open open; do [[ "$(which $cmd)" ]] && break; done
[[ -e "$file" ]] && $cmd "$file"
